#!/usr/bin/env sh

# Pre-push hook: ä½¿ç”¨ Nx å¹¶è¡Œæ‰§è¡Œ CI æ£€æŸ¥
# Nx è‡ªåŠ¨å¤„ç†ç¼“å­˜ã€å¹¶è¡Œåº¦å’Œé”™è¯¯æŠ¥å‘Š

set -e

echo ""
echo "ğŸš€ Running local CI with Nx..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Stash uncommitted changes to test committed code only
if ! git diff --quiet || ! git diff --cached --quiet; then
  git stash push --keep-index --include-untracked -q -m "pre-push-hook"
  STASHED=1
else
  STASHED=0
fi

# Cleanup function
cleanup() {
  if [ "$STASHED" = "1" ]; then
    git stash pop -q 2>/dev/null || true
  fi
}
trap cleanup EXIT

echo ""
echo "âš¡ Running CI tasks (Nx will use cache when possible)..."
echo ""

# Run all CI tasks via Nx (è‡ªåŠ¨å¹¶è¡Œ + ç¼“å­˜)
if npm run ci --silent; then
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "âœ… All checks passed!"
  echo ""
  exit 0
else
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "âŒ Local CI failed. Push aborted."
  echo ""
  echo "ğŸ’¡ To skip (not recommended): git push --no-verify"
  echo "ğŸ’¡ To see detailed logs: npm run ci"
  exit 1
fi
