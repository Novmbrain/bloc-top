# RBAC Phase 3: Editor UI Adaptation — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Filter editor crag lists by user permissions and add role-based UI visibility controls

**Architecture:** Create a server-side `/api/editor/crags` endpoint that returns only crags the authenticated user can edit. Modify `useCragRoutes` hook to use this endpoint in editor mode. Add role-based conditional rendering to the hub page and admin guard to the cities page.

**Tech Stack:** Next.js App Router, better-auth `useSession`, MongoDB `crag_permissions`, Vitest

---

## Context

- Phase 1 (committed): RBAC data model, permissions utilities, auth config
- Phase 2 (committed): API route protection for all editor endpoints
- Review fixes (committed): C1 bug fix, I1-I5 improvements, S1-S2 tests
- All editor pages use `useCragRoutes()` hook → fetches `/api/crags` → all crags visible
- `CragSelector` already accepts a `crags: Crag[]` prop (no interface changes needed)
- `useSession()` from better-auth provides `user.role` on the client

### Key Files

| File | Role |
|------|------|
| `src/hooks/use-crag-routes.ts` | Central data hook for all editor pages |
| `src/app/[locale]/editor/page.tsx` | Hub page with navigation cards |
| `src/app/[locale]/editor/cities/page.tsx` | Cities management (admin-only) |
| `src/app/[locale]/editor/routes/page.tsx` | Routes editor (uses useCragRoutes) |
| `src/app/[locale]/editor/faces/page.tsx` | Faces editor (uses useCragRoutes) |
| `src/app/[locale]/editor/betas/page.tsx` | Betas editor (uses useCragRoutes) |
| `src/lib/permissions.ts` | `getEditableCragIds()` function |
| `src/lib/require-auth.ts` | `requireAuth()` helper |

---

### Task 1: Create `/api/editor/crags` endpoint

**Files:**
- Create: `src/app/api/editor/crags/route.ts`
- Test: `src/app/api/editor/crags/route.test.ts`

**Step 1: Write the failing test**

```typescript
// src/app/api/editor/crags/route.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { NextRequest, NextResponse } from 'next/server'

vi.mock('@/lib/mongodb', () => ({
  getDatabase: vi.fn(),
}))

vi.mock('@/lib/require-auth', () => ({
  requireAuth: vi.fn(),
}))

vi.mock('@/lib/permissions', () => ({
  getEditableCragIds: vi.fn(),
}))

vi.mock('@/lib/db', () => ({
  getAllCrags: vi.fn(),
}))

vi.mock('@/lib/logger', () => ({
  createModuleLogger: () => ({
    info: vi.fn(), error: vi.fn(), warn: vi.fn(), debug: vi.fn(),
  }),
}))

import { GET } from './route'
import { requireAuth } from '@/lib/require-auth'
import { getEditableCragIds } from '@/lib/permissions'
import { getAllCrags } from '@/lib/db'

const mockRequireAuth = vi.mocked(requireAuth)
const mockGetEditableCragIds = vi.mocked(getEditableCragIds)
const mockGetAllCrags = vi.mocked(getAllCrags)

function createRequest(): NextRequest {
  return new NextRequest('http://localhost:3000/api/editor/crags')
}

const ALL_CRAGS = [
  { id: 'crag-1', name: '岩场A', cityId: 'city1' },
  { id: 'crag-2', name: '岩场B', cityId: 'city1' },
  { id: 'crag-3', name: '岩场C', cityId: 'city2' },
]

describe('GET /api/editor/crags', () => {
  beforeEach(() => vi.clearAllMocks())

  it('should return 401 when not authenticated', async () => {
    mockRequireAuth.mockResolvedValue(
      NextResponse.json({ success: false, error: '未登录' }, { status: 401 })
    )
    const res = await GET(createRequest())
    expect(res.status).toBe(401)
  })

  it('should return all crags for admin', async () => {
    mockRequireAuth.mockResolvedValue({ userId: 'admin1', role: 'admin' })
    mockGetEditableCragIds.mockResolvedValue('all')
    mockGetAllCrags.mockResolvedValue(ALL_CRAGS as any)

    const res = await GET(createRequest())
    expect(res.status).toBe(200)
    const data = await res.json()
    expect(data.crags).toHaveLength(3)
  })

  it('should return only permitted crags for crag_creator', async () => {
    mockRequireAuth.mockResolvedValue({ userId: 'user1', role: 'crag_creator' })
    mockGetEditableCragIds.mockResolvedValue(['crag-1', 'crag-3'])
    mockGetAllCrags.mockResolvedValue(ALL_CRAGS as any)

    const res = await GET(createRequest())
    expect(res.status).toBe(200)
    const data = await res.json()
    expect(data.crags).toHaveLength(2)
    expect(data.crags.map((c: any) => c.id)).toEqual(['crag-1', 'crag-3'])
  })

  it('should return empty array for user with no permissions', async () => {
    mockRequireAuth.mockResolvedValue({ userId: 'user2', role: 'user' })
    mockGetEditableCragIds.mockResolvedValue([])
    mockGetAllCrags.mockResolvedValue(ALL_CRAGS as any)

    const res = await GET(createRequest())
    expect(res.status).toBe(200)
    const data = await res.json()
    expect(data.crags).toEqual([])
  })

  it('should include role and canCreate in response', async () => {
    mockRequireAuth.mockResolvedValue({ userId: 'user1', role: 'crag_creator' })
    mockGetEditableCragIds.mockResolvedValue(['crag-1'])
    mockGetAllCrags.mockResolvedValue(ALL_CRAGS as any)

    const res = await GET(createRequest())
    const data = await res.json()
    expect(data.role).toBe('crag_creator')
    expect(data.canCreate).toBe(true)
  })
})
```

**Step 2: Run test to verify it fails**

Run: `npx vitest run src/app/api/editor/crags/route.test.ts`
Expected: FAIL — cannot find `./route`

**Step 3: Write the endpoint implementation**

```typescript
// src/app/api/editor/crags/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { requireAuth } from '@/lib/require-auth'
import { getEditableCragIds, canCreateCrag } from '@/lib/permissions'
import { getAllCrags } from '@/lib/db'

/**
 * GET /api/editor/crags
 * 返回当前用户可编辑的岩场列表（编辑器专用）
 * 同时返回 role 和 canCreate 供前端 UI 决策
 */
export async function GET(request: NextRequest) {
  const authResult = await requireAuth(request)
  if (authResult instanceof NextResponse) return authResult
  const { userId, role } = authResult

  const editableIds = await getEditableCragIds(userId, role)
  const allCrags = await getAllCrags()

  const crags = editableIds === 'all'
    ? allCrags
    : allCrags.filter(c => editableIds.includes(c.id))

  return NextResponse.json({
    crags,
    role,
    canCreate: canCreateCrag(role),
  })
}
```

**Step 4: Run test to verify it passes**

Run: `npx vitest run src/app/api/editor/crags/route.test.ts`
Expected: PASS (5 tests)

**Step 5: Commit**

```bash
git add src/app/api/editor/crags/route.ts src/app/api/editor/crags/route.test.ts
git commit -m "feat(rbac): add /api/editor/crags endpoint for filtered crag list

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 2: Modify `useCragRoutes` to support editor mode

**Files:**
- Modify: `src/hooks/use-crag-routes.ts`

**Step 1: Add `editorMode` option to the hook**

In `UseCragRoutesOptions`, add:
```typescript
interface UseCragRoutesOptions {
  includeFaces?: boolean
  /** 编辑器模式：从 /api/editor/crags 获取权限过滤后的岩场列表 */
  editorMode?: boolean
}
```

Modify the fetch in the `loadCrags` function:
```typescript
const endpoint = editorMode ? '/api/editor/crags' : '/api/crags'
const response = await fetch(endpoint)
```

Store `role` and `canCreate` from the editor response:
```typescript
const [userRole, setUserRole] = useState<string | null>(null)
const [canCreate, setCanCreate] = useState(false)

// in loadCrags:
if (editorMode && data.role) {
  setUserRole(data.role)
  setCanCreate(data.canCreate ?? false)
}
```

Return new fields:
```typescript
return {
  // ... existing fields ...
  ...(editorMode ? { userRole, canCreate } : {}),
}
```

**Step 2: Run existing tests + type check**

Run: `npx vitest run && npx tsc --noEmit`
Expected: PASS (no breaking changes — editorMode is optional, default false)

**Step 3: Commit**

```bash
git add src/hooks/use-crag-routes.ts
git commit -m "feat(rbac): add editorMode to useCragRoutes for filtered crag loading

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 3: Update editor pages to use `editorMode: true`

**Files:**
- Modify: `src/app/[locale]/editor/routes/page.tsx`
- Modify: `src/app/[locale]/editor/faces/page.tsx`
- Modify: `src/app/[locale]/editor/betas/page.tsx`

**Step 1: Update each page's `useCragRoutes` call**

All three pages currently call:
```typescript
const { crags, routes, ... } = useCragRoutes()
// or
const { crags, routes, ... } = useCragRoutes({ includeFaces: true })
```

Change to:
```typescript
const { crags, routes, ... } = useCragRoutes({ editorMode: true })
// or
const { crags, routes, ... } = useCragRoutes({ includeFaces: true, editorMode: true })
```

This is a one-line change per file. No test needed — the visual behavior changes (fewer crags shown) are covered by the API test in Task 1.

**Step 2: Run type check**

Run: `npx tsc --noEmit`
Expected: PASS

**Step 3: Commit**

```bash
git add src/app/[locale]/editor/routes/page.tsx src/app/[locale]/editor/faces/page.tsx src/app/[locale]/editor/betas/page.tsx
git commit -m "feat(rbac): editor pages use editorMode for permission-filtered crags

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 4: Hub page role-based card visibility

**Files:**
- Modify: `src/app/[locale]/editor/page.tsx`

**Step 1: Add `useSession` and conditional card rendering**

Import `useSession` from auth-client and use `role` to filter cards:

```typescript
import { useSession } from '@/lib/auth-client'

export default function TopoEditorPage() {
  const { data: session } = useSession()
  const userRole = (session?.user as { role?: string })?.role || 'user'

  const allCards = [
    // ... existing 5 cards, add `adminOnly` flag to cities card
  ]

  const cards = allCards.filter(card => {
    if (card.adminOnly && userRole !== 'admin') return false
    return true
  })

  // ... rest unchanged
}
```

**Visibility rules:**
| Card | Visibility |
|------|-----------|
| 岩场管理 | All editor users (admin, crag_creator, manager) |
| 岩面管理 | All editor users |
| 线路标注 | All editor users |
| Beta 管理 | All editor users |
| 城市管理 | Admin only |

**Step 2: Run type check**

Run: `npx tsc --noEmit`
Expected: PASS

**Step 3: Commit**

```bash
git add src/app/[locale]/editor/page.tsx
git commit -m "feat(rbac): hub page hides cities card for non-admin users

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 5: Cities page admin guard

**Files:**
- Modify: `src/app/[locale]/editor/cities/page.tsx`

**Step 1: Add client-side admin check**

Add `useSession` check at the top of the component:

```typescript
import { useSession } from '@/lib/auth-client'
import { useRouter } from '@/i18n/navigation'

export default function CityManagementPage() {
  const { data: session, isPending } = useSession()
  const router = useRouter()
  const userRole = (session?.user as { role?: string })?.role || 'user'

  // Redirect non-admin users
  useEffect(() => {
    if (!isPending && userRole !== 'admin') {
      router.replace('/editor')
    }
  }, [isPending, userRole, router])

  if (isPending || userRole !== 'admin') {
    return <LoadingSpinner />  // existing loading state
  }

  // ... rest of existing component
}
```

**Step 2: Run type check**

Run: `npx tsc --noEmit`
Expected: PASS

**Step 3: Commit**

```bash
git add src/app/[locale]/editor/cities/page.tsx
git commit -m "feat(rbac): cities page redirects non-admin users to editor hub

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 6: Verify `getAllCrags` export exists in db module

**Files:**
- Check: `src/lib/db/index.ts`

**Step 1: Verify the function exists**

The new `/api/editor/crags` endpoint imports `getAllCrags` from `@/lib/db`. Verify this function exists and is exported. If not, create it.

**Step 2: Add if missing**

```typescript
// If getAllCrags doesn't exist in src/lib/db/index.ts, add:
export async function getAllCrags(): Promise<Crag[]> {
  const db = await getDatabase()
  return db.collection<Crag>('crags').find({}).toArray()
}
```

**Step 3: Run all tests**

Run: `npx vitest run`
Expected: ALL PASS

**Step 4: Commit (if changes were needed)**

```bash
git add src/lib/db/index.ts
git commit -m "feat(rbac): add getAllCrags helper for editor endpoint

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 7: Full verification + final commit

**Step 1: Run full test suite**

Run: `npx vitest run`
Expected: ALL PASS

**Step 2: Run TypeScript check**

Run: `npx tsc --noEmit`
Expected: 0 errors

**Step 3: Run ESLint**

Run: `npx eslint src/app/api/editor/ src/hooks/use-crag-routes.ts src/app/\[locale\]/editor/`
Expected: 0 errors

**Step 4: Run build**

Run: `npm run build`
Expected: Build success

**Step 5: Update design doc status**

In `doc/RBAC_DESIGN.md`, update Phase 3 status to "已完成".

**Step 6: Final commit**

```bash
git add doc/RBAC_DESIGN.md
git commit -m "docs: mark RBAC Phase 3 as complete

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## Verification Checklist

- [ ] Admin user sees all crags in editor dropdown
- [ ] crag_creator sees only their created crags + assigned crags
- [ ] manager sees only their assigned crags
- [ ] Cities card hidden for non-admin on hub page
- [ ] Cities page redirects non-admin to /editor
- [ ] All existing tests pass
- [ ] New API endpoint has 5 tests covering auth + filtering
- [ ] TypeScript and ESLint clean
