# RBAC Phase 6: Verification & Documentation — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Finalize the RBAC system with documentation updates, test verification, and a comprehensive testing checklist. Mark the entire RBAC project as complete.

**Architecture:** Update `AUTH_SYSTEM.md` with RBAC architecture details, verify existing test coverage, update the editor layout guard documentation, and create a final verification checklist.

**Tech Stack:** Vitest (testing), Markdown (documentation).

---

## Context

### Already Implemented (Phases 1-5)

- **Phase 1**: Data model — `UserRole`, `CragPermission`, `CragPermissionRole` types; `crag_permissions` collection; `permissions.ts` with AC definitions + 6 permission functions
- **Phase 2**: API protection — all editor API routes use `requireAuth` + permission checks; `crag-permissions` CRUD API
- **Phase 3**: Editor UI filtering — crag list filtered by `getEditableCragIds`; editor hub conditionally shows admin cards
- **Phase 4**: Admin user management — `editor/users/page.tsx` with search, pagination, role assignment via `authClient.admin.setRole()`
- **Phase 5**: Crag permission management — `CragPermissionsPanel` component; `editor/crags/[id]/page.tsx`; `/api/editor/search-users` endpoint

### Current Documentation State

| Document | RBAC Status |
|----------|-------------|
| `CLAUDE.md` | ✅ Has RBAC section (lines 397-412), all Phase 5 files listed |
| `doc/RBAC_DESIGN.md` | ✅ Comprehensive design doc, status = "Phase 5 已完成" |
| `doc/AUTH_SYSTEM.md` | ❌ Section "编辑器权限保护" (line 297) still says `role !== 'admin'` — needs RBAC update |

### Current Test State

| Module | Coverage |
|--------|----------|
| `permissions.ts` (6 functions) | ✅ 100% — all functions tested in `permissions.test.ts` |
| `require-auth.ts` | ❌ No unit tests (but it's a thin wrapper around better-auth `getSession`) |
| API routes (crag-permissions, search-users, etc.) | ❌ No unit tests (tested via integration in Phase 5) |

---

### Task 1: Update `AUTH_SYSTEM.md` with RBAC Architecture

**Files:**
- Modify: `doc/AUTH_SYSTEM.md` (section "编辑器权限保护" at line 297)

**Step 1: Replace the outdated editor protection section**

Replace the current "编辑器权限保护" section (lines 297-311) with a comprehensive RBAC section. The new section should cover:

1. Two-layer architecture overview (user roles + crag-level permissions)
2. User roles table (`admin` / `crag_creator` / `user`)
3. Crag permissions table (`creator` / `manager`)
4. Permission decision flow
5. Key files reference
6. Editor layout guard (updated from simple `role !== 'admin'` to `canAccessEditor`)
7. API route protection pattern

Replace lines 297-311 with:

```markdown
## RBAC 权限系统

> 详细设计文档见 `doc/RBAC_DESIGN.md`

### 两层架构

```
┌─────────────────────────────────────────────────────┐
│ 用户级角色 (user.role)                               │
│ ┌─────────┐  ┌──────────────┐  ┌──────────┐        │
│ │  admin   │  │ crag_creator │  │   user   │        │
│ │ 全部权限 │  │ 创建岩场+管理 │  │ 仅浏览   │        │
│ └─────────┘  └──────────────┘  └──────────┘        │
├─────────────────────────────────────────────────────┤
│ 岩场级权限 (crag_permissions collection)             │
│ ┌──────────────┐  ┌──────────────┐                  │
│ │   creator    │  │   manager    │                  │
│ │ 删除+分配权限 │  │ 编辑线路/岩面 │                  │
│ └──────────────┘  └──────────────┘                  │
└─────────────────────────────────────────────────────┘
```

### 用户角色

| 角色 | 说明 | 编辑器 | 创建岩场 | 编辑任意岩场 |
|------|------|--------|---------|-------------|
| `admin` | 超级管理员 | ✅ | ✅ | ✅ |
| `crag_creator` | 岩场创建者 | ✅ | ✅ | 仅自己的 |
| `user` | 普通用户 | 仅被分配岩场 | ❌ | 仅被分配的 |

通过 better-auth Admin 插件管理: `authClient.admin.setRole({ userId, role })`

### 岩场级权限

| 权限 | 编辑线路/岩面 | 删除岩场 | 分配管理者 |
|------|-------------|---------|-----------|
| `creator` | ✅ | ✅ | ✅ |
| `manager` | ✅ | ❌ | ❌ |

存储在 `crag_permissions` collection: `{ userId, cragId, role, assignedBy, createdAt }`

### 权限判定函数

位于 `src/lib/permissions.ts`:

| 函数 | 用途 | Admin 行为 |
|------|------|-----------|
| `canAccessEditor(userId, role)` | 编辑器入口 | 直接放行 |
| `canCreateCrag(role)` | 创建岩场 | 直接放行 |
| `canEditCrag(userId, cragId, role)` | 编辑岩场 | 直接放行 |
| `canDeleteCrag(userId, cragId, role)` | 删除岩场 | 直接放行 |
| `canManagePermissions(userId, cragId, role)` | 管理权限 | 直接放行 |
| `getEditableCragIds(userId, role)` | 获取可编辑岩场列表 | 返回 `'all'` |

### 编辑器访问保护

**Server-side (layout.tsx)**:

```typescript
// editor/layout.tsx — Server Component
const session = await auth.api.getSession({ headers: await headers() })
if (!session) redirect('/login')
// Note: layout 仅检查登录状态，具体权限由各页面/API 自行检查
```

**API Route Pattern**:

```typescript
import { requireAuth } from '@/lib/require-auth'
import { canEditCrag } from '@/lib/permissions'

export async function PATCH(request: NextRequest) {
  const authResult = await requireAuth(request)
  if (authResult instanceof NextResponse) return authResult
  const { userId, role } = authResult

  if (!(await canEditCrag(userId, cragId, role))) {
    return NextResponse.json({ error: '无权限' }, { status: 403 })
  }
  // ... handle request
}
```

### 相关 API

| 方法 | 路径 | 权限 |
|------|------|------|
| `GET/POST/DELETE` | `/api/crag-permissions` | creator / admin |
| `GET` | `/api/editor/crags` | 任何有编辑器权限的用户 |
| `GET` | `/api/editor/search-users?q=xxx` | 任何有编辑器权限的用户 |
```

**Step 2: Update the "待办事项" section**

In the TODO section, add a completed item for RBAC:

```markdown
- [x] RBAC 权限系统 — 用户角色 + 岩场级权限 (详见 `doc/RBAC_DESIGN.md`)
```

**Step 3: Verify the file renders correctly**

Read back the modified file to confirm no formatting issues.

**Step 4: Commit**

```bash
git add doc/AUTH_SYSTEM.md
git commit -m "docs: add RBAC architecture section to AUTH_SYSTEM.md

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 2: Update editor layout guard to use canAccessEditor

**Files:**
- Modify: `src/app/[locale]/editor/layout.tsx`

**Context:** The current editor layout still uses the old `role !== 'admin'` check (from before RBAC). This should be updated to use the permissions system so that `crag_creator` users and users with crag permissions can also access the editor.

**Step 1: Read the current layout**

Read `src/app/[locale]/editor/layout.tsx` to understand the current guard logic.

**Step 2: Update the guard**

Replace the simple `role !== 'admin'` check with `canAccessEditor(userId, role)`. Since `layout.tsx` is a Server Component and `canAccessEditor` is an async function, this is straightforward:

```typescript
import { canAccessEditor } from '@/lib/permissions'

// In the layout function:
const session = await auth.api.getSession({ headers: await headers() })
if (!session) redirect('/login')

const userId = session.user.id
const userRole = (session.user.role as string) || 'user'

if (!(await canAccessEditor(userId, userRole as UserRole))) {
  redirect('/login')
}
```

**Important**: Import `UserRole` from `@/types`. The `session.user.role` may need a type assertion since better-auth types don't include our custom `role` field.

**Step 3: Run TypeScript check**

Run: `npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```bash
git add src/app/[locale]/editor/layout.tsx
git commit -m "feat(rbac): update editor layout guard to use canAccessEditor

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 3: Mark RBAC project as complete + final RBAC_DESIGN.md update

**Files:**
- Modify: `doc/RBAC_DESIGN.md` — change status to "完成"

**Step 1: Update the status line**

Change:
```
> 状态: **Phase 5 已完成** | ...
```
To:
```
> 状态: **✅ 完成** | 创建: 2026-02-13 | Phase 1-5: 2026-02-13 ~ 2026-02-14 | Phase 6: 2026-02-14
```

**Step 2: Commit**

```bash
git add doc/RBAC_DESIGN.md
git commit -m "docs: mark RBAC project as complete

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

### Task 4: Full verification

**Step 1: Run full test suite**

Run: `npx vitest run`
Expected: ALL PASS (except known `isToday` timezone issue)

**Step 2: Run TypeScript check**

Run: `npx tsc --noEmit`
Expected: 0 errors

**Step 3: Run build**

Run: `npm run build`
Expected: Build success

**Step 4: Verify all docs are consistent**

- `CLAUDE.md` has RBAC section with correct files
- `AUTH_SYSTEM.md` has RBAC architecture section
- `RBAC_DESIGN.md` status is "完成"

No commit needed — this is a verification step only.

---

## Verification Checklist

- [ ] All permission functions have unit tests (permissions.test.ts)
- [ ] AUTH_SYSTEM.md documents the complete RBAC architecture
- [ ] Editor layout uses `canAccessEditor` instead of `role !== 'admin'`
- [ ] RBAC_DESIGN.md status is "完成"
- [ ] TypeScript, tests, and build all pass
- [ ] CLAUDE.md has all RBAC-related files and sections
